# 唯一列用普通索引还是唯一索引

比如说有一个市民管理系统，要在身份证列上建索引。

那么建立唯一索引还是普通索引呢？为什么？

普通索引与唯一索引最明显的区别就是：普通索引的字段可以写入重复的值，而唯一索引不行。

## 查询分析

首先，普通索引和唯一索引都需要做的是：

从B+树的树根开始，按层搜索数据页，然后再数据页内部通过二分查找定位记录。

两者的差别在于：定位到数据后是否要继续查找。

唯一索引：找到第一个满足条件的记录就立刻返回。

普通索引：找到第一个满足条件的记录后还应该继续查找。

然而，InnoDB的数据是以数据页为单位进行读写的。当我们读取一条记录时，并不是将这个记录本身从磁盘中读出来，而是以页为单位，将其整体读入内存。InnoDB的每个数据页大小默认为16KB。

所以对于普通索引，损耗的性能并不多。

当然如果k=5这个记录刚好是这个数据页的最后一个记录，那么要取下一个记录，必须要读下一个数据页，这个操作会复杂一些。但是这个概率很低。

## 更新分析

> change buffer是buffer pool里面的内存。
>
> - 当更新数据时，如果数据页在内存中就直接更新；
>
> - 如果不在的话，InnoDB会把这些更新操作缓存到change buffer中，这样就不用从磁盘中读取这个数据页了。
>
> 那么如何保证数据逻辑的正确性呢？
>
> 在下次查询需要访问这个数据页时，将数据页读入内存，然后执行change buffer中与这个页的merge操作。
>
> 除了访问这个数据页会有mergea操作，系统有后台线程会定期merge。在数据库正常关闭的过程中，也会执行merge操作。
>
> 综上，如果数据页不在内存中，会把更新操作先记录在change buffer上，减少磁盘读取次数。



**唯一索引不会使用change buffer。**

因为对唯一索引的操作要做唯一性约束判断。所以必须要将数据页读入内存判断。

如果都已经读入到内存了，那直接更新内存会更快，就没必要用change buffer了。

主键索引也属于唯一索引哦。

普通索引可以使用change buffer。



那么如果要在表中插入一条记录的话，InnoDB的处理流程是怎样的？

- 该记录要更新的目标页在内存中

1. 1. 唯一索引：找到对应的位置，判断有没有冲突，插入这个值；
   2. 普通索引：找到对应的位置，插入值；

- 该记录要更新的目标页不在内存中

1. 1. 唯一索引：将这个页读入到内存中，判断有无冲突，插入这个值；
   2. 普通索引：将记录更细到change buffer；

将数据从硬盘读入内存成本很高，change buffer对性能的提升很大。



综上，两类索引的查询能力基本没差别，主要考虑更新对性能的影响。

在写多读少的情况下普通索引会更好，如果在写完之后立刻读的化唯一索引可能更快。

# 思考

change buffer一开始是写内存的，那么如果这个时候机器掉电重启，会不会导致change buffer丢失呢？change buffer丢失可不是小事儿，再从磁盘读入数据可就没有了merge过程，就等于是数据丢失了。会不会出现这种情况呢？

change buffer会丢失，但是更新不会丢失，因为有redo log。

